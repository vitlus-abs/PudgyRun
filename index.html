<!DOCTYPE html>
<html lang="en-us">
  <head>
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Pudgy Run</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">

    <!-- Simple styling for the debug console overlay -->
    <style>
      #debug-console {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 40%;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        font-family: monospace;
        padding: 8px;
        box-sizing: border-box;
        z-index: 9999;
      }
    </style>
  </head>

  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <!-- Fullscreen button for fallback outside Telegram -->
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Pudgy Run</div>
      </div>
    </div>

    <!-- Debug console container -->
    <div id="debug-console"></div>

    <script>
      // === Debug Logging Function ===
      function debugLog(message) {
        const debugDiv = document.getElementById('debug-console');
        if (!debugDiv) return; // Just in case the element doesn't exist

        const line = document.createElement('p');
        line.textContent = message;
        debugDiv.appendChild(line);

        // Auto-scroll to the bottom
        debugDiv.scrollTop = debugDiv.scrollHeight;
      }

      // === DOM References ===
      var container        = document.querySelector("#unity-container");
      var canvas           = document.querySelector("#unity-canvas");
      var loadingBar       = document.querySelector("#unity-loading-bar");
      var progressBarFull  = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var warningBanner    = document.querySelector("#unity-warning");

      // === Show Warning / Error Banner ===
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);

        if (type === 'error') {
          div.style = 'background: red; padding: 10px;';
        } else if (type === 'warning') {
          div.style = 'background: yellow; padding: 10px;';
          setTimeout(function () {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      // === Unity Build Config ===
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/BUILD.loader.js";
      var config = {
        dataUrl: buildUrl + "/BUILD.data",
        frameworkUrl: buildUrl + "/BUILD.framework.js",
        codeUrl: buildUrl + "/BUILD.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "vitlus",
        productName: "Pudgy Run",
        productVersion: "2.0.0",
        showBanner: unityShowBanner,
      };

      // Log initialization
      debugLog("Starting setup...");

      // === Mobile vs Desktop Handling ===
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        debugLog("Mobile user detected. Applying mobile styles/viewport.");

        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);

        container.className = "unity-mobile";
        canvas.className = "unity-mobile";
        
        // If you want to lower the device pixel ratio for performance:
        // config.devicePixelRatio = 1;
      } else {
        debugLog("Desktop user detected. Setting fixed canvas size.");

        // Desktop: fixed-size canvas
        canvas.style.width = "960px";
        canvas.style.height = "600px";
      }

      // === Show Loading Bar ===
      loadingBar.style.display = "block";

      // === Inject the Unity Loader Script ===
      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        debugLog("Unity loader script loaded. Creating Unity instance...");

        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = (100 * progress) + "%";
        }).then((unityInstance) => {
          debugLog("Unity instance created successfully.");
          // Hide the loading bar when done
          loadingBar.style.display = "none";

         // -----------------------------------------------
          // 1. Check if running in Telegram WebApp
          // 2. If yes, attempt orientation lock & fullscreen
          // -----------------------------------------------
          if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            debugLog("Telegram.WebApp detected. Attempting orientation lock & fullscreen...");

            // Attempt to lock orientation in landscape
            if (Telegram.WebApp.lockOrientation) {
              try {
                Telegram.WebApp.lockOrientation("landscape");
                debugLog("Orientation lock success: landscape.");
              } catch (err) {
                debugLog("Orientation lock failed or not supported: " + err);
              }
            } else {
              debugLog("Telegram.WebApp.lockOrientation not supported in this environment.");
            }

            // Then request fullscreen
            if (Telegram.WebApp.requestFullscreen) {
              try {
                Telegram.WebApp.requestFullscreen();
                debugLog("Entered Telegram fullscreen successfully.");
              } catch (err) {
                debugLog("Telegram.WebApp.requestFullscreen failed: " + err);
                // Fallback to Unity's built-in fullscreen
                unityInstance.SetFullscreen(1);
                debugLog("Falling back to Unity fullscreen.");
              }
            } else {
              debugLog("Telegram.WebApp.requestFullscreen not supported. Using Unity fullscreen.");
              unityInstance.SetFullscreen(1);
            }
          } else {
            debugLog("Not running inside Telegram. Using default settings.");
          }

          // -----------------------------------------------
          // Fallback fullscreen button for non-Telegram usage
          // -----------------------------------------------
          fullscreenButton.onclick = () => {
            debugLog("Fullscreen button pressed. Using Unity's native fullscreen.");
            unityInstance.SetFullscreen(1);
          };
        }).catch((message) => {
          debugLog("Unity instance creation failed: " + message);
          alert(message);
        });
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
